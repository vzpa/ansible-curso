---
# Auditoría de Microsoft Defender

- name: Verificar estado de Real-Time Protection
  ansible.windows.win_shell: Get-MpPreference | Select-Object -Property DisableRealtimeMonitoring | ConvertTo-Json
  args:
    executable: powershell.exe
  register: rt_protection
  changed_when: false
  # Comentario: Debe ser False (habilitado)

- name: Verificar Cloud Protection
  ansible.windows.win_shell: Get-MpPreference | Select-Object -Property MAPSReporting | ConvertTo-Json
  args:
    executable: powershell.exe
  register: cloud_protection
  changed_when: false
  # Comentario: Debe ser 2 (Advanced)

- name: Registrar resultados Defender
  set_fact:
    audit_results: "{{ audit_results | combine({ 'defender': {
      'realtime_enabled': (rt_protection.stdout | from_json).DisableRealtimeMonitoring == $false,
      'cloud_enabled': (cloud_protection.stdout | from_json).MAPSReporting == 2} }) }}"
  # Comentario: Severidad crítica si disabled, expone a malware zero-day.