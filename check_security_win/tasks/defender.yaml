- name: Intentar obtener configuración de Defender (solo si servicio está corriendo)
  ansible.windows.win_shell: |
    $prefs = Get-MpPreference -ErrorAction SilentlyContinue
    if ($prefs) {
      @{
        DisableRealtimeMonitoring = $prefs.DisableRealtimeMonitoring
        MAPSReporting             = $prefs.MAPSReporting
        SubmitSamplesConsent      = $prefs.SubmitSamplesConsent
      } | ConvertTo-Json -Compress
    } else {
      @{
        'error' = 'Cannot query MpPreference - likely service not running (0x800106ba)'
      } | ConvertTo-Json -Compress
    }
  args:
    executable: powershell.exe
  register: defender_prefs
  ignore_errors: true
  changed_when: false