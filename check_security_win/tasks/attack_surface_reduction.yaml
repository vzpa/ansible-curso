---
# tasks/attack_surface_reduction.yml – Versión corregida y robusta

- name: Verificar estado del servicio de Windows Defender (para ASR)
  ansible.windows.win_service_info:
    name: WinDefend
  register: windefend_service
  ignore_errors: true
  failed_when: false

- name: Intentar obtener configuración ASR (solo si Defender está activo)
  ansible.windows.win_shell: |
    $prefs = Get-MpPreference -ErrorAction SilentlyContinue
    if ($prefs) {
      @{
        AttackSurfaceReductionRules_Actions = $prefs.AttackSurfaceReductionRules_Actions
        AttackSurfaceReductionRules_Ids     = $prefs.AttackSurfaceReductionRules_Ids
      } | ConvertTo-Json -Compress
    } else {
      @{ 
        status = 'Defender service not running - cannot query ASR rules (0x800106ba)'
      } | ConvertTo-Json -Compress
    }
  args:
    executable: powershell.exe
  register: asr_config
  ignore_errors: true
  changed_when: false
  failed_when: false

- name: Registrar resultados ASR (versión tolerante)
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results | default({}) | combine({
      'asr': {
        'defender_service_running': windefend_service.exists | default(false) and 
                                    (windefend_service.services | default([]) | selectattr('state', 'equalto', 'running') | list | length > 0),
        'query_success': asr_config.rc == 0 and 'status' not in (asr_config.stdout | from_json | default({})),
        'raw_output': asr_config.stdout | from_json | default({ status: 'Cannot query ASR - Defender not running' }),
        'overall_status': 'CRITICAL - Defender no activo, ASR no queryable' 
                          if not (windefend_service.exists | default(false)) or 
                             (windefend_service.services | default([]) | length == 0) or 
                             (windefend_service.services | first | default({})).state != 'running'
                          else 'Active (ASR query OK)',
        'severity': 'critical' if not (windefend_service.exists | default(false)) or 
                                   (windefend_service.services | default([]) | length == 0) or 
                                   (windefend_service.services | first | default({})).state != 'running'
                          else 'medium'
      }}) }}"