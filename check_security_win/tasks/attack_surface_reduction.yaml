---
# Auditoría de Attack Surface Reduction

- name: Auditar ASR rules
  ansible.windows.win_shell: Get-MpPreference | Select-Object -Property AttackSurfaceReductionRules_Actions, AttackSurfaceReductionRules_Ids | ConvertTo-Json
  args:
    executable: powershell.exe
  register: asr_config
  changed_when: false
  # Comentario: Verifica si rules están en Block mode

- name: Procesar ASR results
  set_fact:
    asr_results: []
  loop: "{{ asr_rules }}"
  loop_control:
    loop_var: rule
  vars:
    rule_state: "{{ asr_config.stdout | from_json | json_query('AttackSurfaceReductionRules_Ids[] | [?contains(@, rule.guid)] | AttackSurfaceReductionRules_Actions[0]') | default(0) }}"
    asr_results: "{{ asr_results + [{ 'guid': rule.guid, 'state': rule_state, 'compliant': rule_state == rule.expected, 'severity': rule.severity }] }}"

- name: Registrar resultados ASR
  set_fact:
    audit_results: "{{ audit_results | combine({ 'asr': asr_results }) }}"
  # Comentario: Severidad high; ASR mitiga zero-days en Office, scripts, etc.