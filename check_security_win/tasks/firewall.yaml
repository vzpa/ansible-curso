---
# Auditor√≠a de Windows Firewall

- name: Auditar perfiles de Firewall
  ansible.windows.win_shell: Get-NetFirewallProfile | Select-Object -Property Name, Enabled | ConvertTo-Json
  args:
    executable: powershell.exe
  register: fw_profiles
  changed_when: false
  # Comentario: Todos los perfiles deben estar Enabled (CIS 9.1.1)

- name: Auditar logging de Firewall
  ansible.windows.win_shell: Get-NetFirewallProfile -Name Domain | Select-Object -Property LogAllowed, LogBlocked, LogIgnored | ConvertTo-Json
  args:
    executable: powershell.exe
  register: fw_logging
  changed_when: false
  # Comentario: Logging debe estar True para drops (CIS 9.3.1)

- name: Registrar resultados Firewall
  set_fact:
    audit_results: "{{ audit_results | combine({ 'firewall': {
      'profiles_enabled': fw_profiles.stdout | from_json | default([]) | selectattr('Enabled', 'equalto', $true) | list | length == 3,
      'logging_enabled': (fw_logging.stdout | from_json).LogBlocked == $true} }) }}"
  # Comentario: Severidad alta si profiles disabled, permite inbound attacks.