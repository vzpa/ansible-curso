- name: Procesar resultados registry – versión nativa corregida (sin variables intermedias problemáticas)
  ansible.builtin.set_fact:
    registry_results: >-
      {{
        registry_results | default([]) +
        (
          reg_results.results | default([]) | map('combine', {
            'path': item.item.path | default('unknown'),
            'name': item.item.name | default('unknown'),
            'expected_value': item.item.expected_value | default(None),
            'exists': item.exists | default(false),
            'value': item.value | default('Not set'),
            'compliant': item.exists | default(false) and (item.value | default(None) == item.item.expected_value | default(None)),
            'severity': item.item.severity | default('medium'),
            'description': item.item.description | default('Sin descripción')
          }) | list
        )
      }}
  when: 
    - reg_results is defined
    - reg_results.results is defined
    - reg_results.results | length > 0
  loop: "{{ reg_results.results | default([]) }}"
  loop_control:
    loop_var: item