---
# Auditoría de actualizaciones Windows

- name: Verificar estado de Windows Update Service
  ansible.windows.win_service_info:
    name: wuauserv
  register: wu_service
  # Comentario: wuauserv debe estar running para actualizaciones automáticas

- name: Auditar configuraciones de Windows Update (via registry)
  ansible.windows.win_reg_stat:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
    name: NoAutoUpdate
  register: wu_auto_update
  # Comentario: Debe ser 0 para habilitar actualizaciones automáticas (CIS 18.9.101.1)

- name: Detectar actualizaciones faltantes (PowerShell)
  ansible.windows.win_shell: |
    $session = New-Object -ComObject Microsoft.Update.Session
    $searcher = $session.CreateUpdateSearcher()
    $updates = $searcher.Search("IsInstalled=0 and Type='Software' and IsHidden=0")
    $critical = $updates.Updates | Where-Object { $_.MsrcSeverity -eq 'Critical' }
    $output = @{
      total_missing = $updates.Updates.Count
      critical_missing = $critical.Count
    }
    ConvertTo-Json $output
  args:
    executable: powershell.exe
  register: missing_updates
  changed_when: false
  # Comentario: Solo consulta, no instala. Clasifica críticos para zero-days.

- name: Registrar resultados de updates
  set_fact:
    audit_results: "{{ audit_results | combine({ 'updates': {
      'wu_service_state': wu_service.state | default('unknown'),
      'auto_update_enabled': wu_auto_update.value == 0,
      'missing_updates_total': missing_updates.stdout | from_json | default({}) | json_query('total_missing'),
      'missing_critical': missing_updates.stdout | from_json | default({}) | json_query('critical_missing')} }) }}"
  # Comentario: Severidad alta si hay críticos faltantes, ya que exponen a zero-days conocidos.