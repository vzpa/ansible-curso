- name: Registrar resultados ASR (versión ultra-tolerante)
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results | default({}) | combine({
      'asr': {
        'defender_service': {
          'exists': windefend_service.exists | default(false),
          'running': windefend_service.services | default([]) | selectattr('state', 'equalto', 'running') | list | length > 0 if windefend_service.services is defined else false,
          'state': windefend_service.services | default([]) | first | default({}) | get('state', 'not_found'),
          'start_mode': windefend_service.services | default([]) | first | default({}) | get('start_mode', 'unknown')
        },
        'asr_query': {
          'success': asr_config.rc | default(1) == 0,
          'raw_stdout': asr_config.stdout | default('No output - task failed'),
          'parsed': asr_config.stdout | from_json | default({}) if asr_config.stdout is string else {},
          'status_message': (asr_config.stdout | from_json | default({}) if asr_config.stdout is string else {}).get('status', 'Defender not running - ASR not queryable (0x800106ba)'),
          'has_rules': (asr_config.stdout | from_json | default({}) if asr_config.stdout is string else {}).get('AttackSurfaceReductionRules_Ids', []) | length > 0
        },
        'assessment': {
          'status': 'CRITICAL - Defender service no activo → ASR no disponible',
          'severity': 'critical',
          'notes': 'Get-MpPreference falla con 0x800106ba (servicio WinDefend no running)'
        }
      }}) }}"