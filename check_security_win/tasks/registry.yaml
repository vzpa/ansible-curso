---
# tasks/registry.yaml (versión corregida)

- name: Auditar keys de registry
  ansible.windows.win_reg_stat:
    path: "{{ item.path }}"
    name: "{{ item.name }}"
  register: reg_results
  loop: "{{ critical_registry_keys }}"
  # No necesitas loop_control aquí si no cambias el nombre de 'item'

- name: Procesar resultados registry
  ansible.builtin.set_fact:
    registry_results: >-
      {{
        registry_results | default([]) +
        [{
          'path': item.item.path,
          'name': item.item.name,
          'value': item.value,
          'compliant': item.value == item.item.expected_value,
          'severity': item.item.severity,
          'description': item.item.description
        }]
      }}
  loop: "{{ reg_results.results }}"
  loop_control:
    loop_var: item   # ← opcional, pero recomendado si quieres claridad (en vez de 'item' por defecto)
  # No hay nada más después de loop_control en esta tarea

- name: Registrar resultados registry
  ansible.builtin.set_fact:
    audit_results: "{{ audit_results | combine({ 'registry': registry_results }) }}"