- name: Detectar actualizaciones faltantes (PowerShell) - Sin comentario problem√°tico
  ansible.windows.win_shell: |
    $session = New-Object -ComObject Microsoft.Update.Session
    $searcher = $session.CreateUpdateSearcher()
    $criteria = "IsInstalled=0 and Type='Software' and IsHidden=0"
    $updates = $searcher.Search($criteria)
    $critical = $updates.Updates | Where-Object { $_.MsrcSeverity -eq 'Critical' }
    $output = @{
      total_missing    = $updates.Updates.Count
      critical_missing = $critical.Count
    }
    ConvertTo-Json $output -Compress
  args:
    executable: powershell.exe
  register: missing_updates
  changed_when: false